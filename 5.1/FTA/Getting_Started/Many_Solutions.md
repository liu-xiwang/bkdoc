# 故障自愈套餐大全
故障自愈套餐主要有三类组合套餐： **快捷套餐**、**周边系统**、**组合套餐**，以下为每个套餐的详细说明。

## 1. 快捷套餐
每个业务默认都会有一批可以选择的套餐，用户几乎不需要对其做任何配置可以直接使用。对于这种套餐，我们用称为『快捷』套餐，部分『快捷』套餐只能在组合套餐中选用。

## 1.1 常规快捷套餐

### 1.1 磁盘清理（适用于 Linux）

背后对应一个作业平台套餐，调用作业平台内置的一个跨业务作业，执行磁盘清理。

更多请参考 [创建磁盘清理自愈套餐和方案](Create_Diskclear_Fta_Solutions.md)。

### 1.2 汇总

- 具体操作:
根据配置按一定维度收敛后，发送通知给用户。

- 使用场景:
对于一些大量出现的告警，如单机性能告警、流量告警等，可以用此套餐收敛后发送通知。

- 参数说明:
时间段和告警数必须填一个。

    - 按时间段汇总：从收到第一条告警开始计时，到规定时间后结束。

    - 按告警数汇总：从收到第一条告警开始计数，到规定数量后结束。

    - 少于多少条不通知：选择时间段汇总时，如果到时间后，告警数量少于指定数量，就不发通知。

### 1.3 『快捷』发送 CPU 使用率 TOP10 的进程(微信)

当产生 CPU 使用率时，调用作业平台的作业，通过微信发送 占用 CPU 的 TOP 10 进程列表，辅助运维分析原因。

该套餐实际是一个组合套餐，第 1 步执行作业，第 2 步通过微信发送第 1 步的结果，更多细节请参考 [上下文传参](../Scenes/Context_Parameters.md) 的介绍。

### 1.4 『快捷』发送内存使用率 TOP10 的进程(微信)

同上。


### 1.5  『快捷』CC 移到“故障机”模块

调用蓝鲸配置平台的接口，将故障机移动至当前业务的故障机模块。

## 1.2 组合套餐中的快捷套餐

该分类下套餐仅能在组合套餐中使用。

### 1.2.1 『快捷』配置平台拷贝故障机属性到备机

> （需先调用 获取故障机备机 套餐）

- 具体操作:

    - 调用配置平台替换接口，将替换机转移到与故障机相同的模块下（包括属于故障机多个模块的情况）。

    - 拷贝故障机的标准属性、自定义属性到替换机。

- 使用场景:
故障机切换后拷贝故障机 CC 信息到备机；


### 1.2.2 『快捷』后续处理对象故障机与备机互换

> （需先调用 获取故障机备机 套餐）

- 具体操作:
调用此套餐后，在组合套餐的后续流程中，操作对象将会替换。流程默认都是对故障机进行操作，调用一次后将会默认对备机进行操作。再调用一次，则恢复原状。

- 使用场景:
例如当获取选定的备机后，想对备机进行初始化操作，那么这时候就要先调用一次此套餐，再调用初始化。初始化后，又想把故障机移动到配置平台的故障机模块，那么就又要调用一次此套餐，然后再调用配置平台移动模块。


## 2. 周边系统

故障自愈自身并没有恢复告警的执行能力，而是通过蓝鲸 PaaS 的 ESB 模块调用作业平台、标准运维的能力来实现。

### 2.1 作业平台

调用蓝鲸作业平台，作业平台脚本需要按照一定规范来。

- 具体操作:
调用作业平台作业。

- 使用场景:
希望在机器上执行脚本的故障恢复操作，如拉起进程等。

- 参数说明:
    - 通过选择框选择作业平台作业。

    - 自定义传入作业平台的参数（不填默认传入故障 IP）。

    - 通过作业平台脚本获取自愈变量来在其他套餐中使用。

### 2.2 标准运维流程

同上，区别在于调用的是标准运维。

### 2.3 HTTP 回调

裸调企业内部的恢复告警的处理接口，如重启服务器，不经过蓝鲸 PaaS 的 ESB。

一般不推荐裸调接口。


## 3. 组合套餐类

### 3.1 组合套餐

组合套餐，顾名思义就是把该业务下的套餐和官方通用套餐组合起来使用。

-  具体操作:
按照配置的流程顺序执行套餐

-  使用场景:
当单一的套餐无法满足故障恢复流程时，将套餐串起来用。


### 3.2 获取故障机备机

根据配置平台的配置属性获取备机许多故障替换操作都依赖于此套餐。

除了通过这个套餐获取备机外，也可以通过作业平台来获取备机，只要使用作业平台套餐获取变量为 ip_bak 的参数即可。

- 具体操作:
根据配置，在配置平台指定的 Set 与 AppModule 中，查找指定属性与故障机相同的机器。将所有符合条件的机器 IP 通过微信让运维审批选择。此后备机 IP 就能通过变量在其他套餐中获取。

- 使用场景:
在组合套餐中调用故障替换的操作套餐前必须先调用过此套餐。

更多变量请参考 [套餐内置变量](../Scenes/Solutions_Parameters.md)。

### 3.3 审批

- 具体操作：调用不同的接口发送审批（发送微信失败会改为短信，发送短信失败则发微信，邮件通知接口调用失败将不做处理）。

- 使用场景：一般用于组合套餐中；审批，执行服务器故障替换流程时，让运维审批是否执行替换，降低风险。


### 3.4 通知

- 具体操作：调用不同的接口发送通知（发送微信失败会改为短信，发送短信失败则发微信，邮件通知接口调用失败将不做处理）。

- 使用场景：一般用于组合套餐中，通知，自定义消息发送到微信等平台。


### 3.5 暂停等待

- 具体操作：暂停一定时间。

- 使用场景：重启操作后 Agent 可能还没准备好，可以等待一定时间后再继续后面的流程。

### 3.6. 自定义收敛防御

- 具体操作:
在指定时间内，出现过指定告警数量的相同 IP，相同告警类型，将会收敛次条告警。

- 使用场景:
想添加某些异常防御条件的时候，大部分需求故障自愈的收敛功能就能满足。
