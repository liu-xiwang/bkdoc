# 新建流程

具体步骤：

**新建流程 - 流程名称 - 流程节点 - 全局变量**


1、新建流程

用户可以通过对标准插件节点、子流程节点与网关节点的组合，变量的配置与引用，配置出一个业务流程。

流程名称是用户用来描述流程模板的，默认值是 `new时间格式串`，用户可以自行修改，注意不能包含空格、括号等特殊字符。

用户可以从左边的工具栏，拖拽合适的节点到画布中，并通过连线，组成合法的流程模板。

**注意：** 流程名称不能包含'‘"”$&<>非法字符。

![发布1](../assets/发布1.jpg)

2、工具栏说明

工具栏中流程节点包含流程控制节点和任务节点。流程控制节点包括：
开始节点——标识流程的开始
结束节点——标识流程的结束

一个合法的流程模板只能有一个开始节点和结束节点，开始节点出度（箭头指向节点的连线数量）只能为 1，入度（箭头背离节点的连线数量）为 0。结束节点入度为 1，出度为 0。

![guide1](../assets/guide1.png)

流程控制节点还包括：
并行网关——标识并行执行的开始，
分支网关——标识分支执行的开始，
汇聚网关——标识并行或分支的结束。

请注意，每一个并行网关或者分支网关都需要配置一个汇聚网关来标识并行或分支流程的结束。

并行网关入度为 1，出度不小于 2。并行网关出度上的多个节点在执行时会并发执行，对应的汇聚网关在等待所有并行流程执行完成后才会开始启动后续的流程节点。

![g2](../assets/g2.png)

分支网关和并行网关类似，区别在于分支网关出度上的多个节点在执行时会根据分支条件启动分支表达式为 True 的一个分支流程，其他的分支则不会被执行。启动的分支执行完成后就立刻启动对应的汇聚网关，接着执行后续的流程节点。分支表达式的语法请参考 [附录 2](/10.附录/term2.md#define) 说明。

![g3](../assets/g3.png)

任务节点包括标准插件节点和子流程节点。标准插件节点是标准运维内置的最小执行单元，一般对应于蓝鲸服务总线（ESB）的一次 API 调用或者标准运维内置服务如定时。

单击标准插件节点可以配置标准插件节点的参数。其中标准插件类型可以选择一个标准运维接入的标准插件，输入参数、输出参数和选择的标准插件对应，每个标准插件的参数一般不同，如 "作业平台(JOB)-快速执行脚本" 是对应作业平台的快速执行脚本 API，需要填写脚本类型、脚本内容、脚本参数、超时时间、目标 IP、目标账户等输入参数，在执行时，标准运维会把用户填写的前端参数转换为 ESB 需要的参数格式并调用 API，然后根据 API 返回结果把 JOB 任务 ID、JOB 任务链接、执行结果（成功或失败）作为输出参数展示在执行详情中，后续的流程节点也可以引用前面节点的输出参数。

![发布6](../assets/发布6.jpg)

子流程节点可以选择用户已经创建的流程模板，在新的流程中引用并作为子流程执行。子流程节点的输入参数是选择的流程模板中显示属性为 "显示" 的全局变量，也就是该子流程模板单独创建任务时需要填写的任务参数。输出变量是选择的流程模板中勾选了输出属性的全局变量。

![g4](../assets/sops003.png)

5、全局变量

全局变量是一个流程模板的公共参数，通过 KEY 来做唯一性约束。用户可以在任务节点的输入参数和分支网关表达式中引用，标准运维会在执行任务时自动替换全局变量的引用为全局变量的值。

全局变量的来源有三种：

一是 通过任务节点的输入参数勾选生成，这类全局变量的类型是 "组件"，并且不能更改；默认值和来源标准插件的输入参数的表单类型一致，如标准插件节点的参数是单选框，勾选生成的全局变量也是单选框。

![](../assets/sops004.png)

二是 通过任务节点的输出参数勾选生成，这类全局变量类型也是 "组件"，并且不能更改；无默认值属性，因为这类全局变量的值是由生成该变量的标准插件节点、子流程节点的输出结果自动生成的，用户无法手动设置；此外，这类全局变量的显示属性是 "隐藏"，并且不能更改，表示执行任务时不需要用户手动填写这类参数。

![](../assets/sops005.png)

三是 用户在全局变量区点击 【新增变量】 生成，手动添加的全局变量类型可以选择输入框、文本框、日期时间、整数、IP 选择器等，并且可以随时切换；这类变量可以自定义校验规则，这样在创建任务填写参数时，可以避免填写不合法的参数值。

![](../assets/sops006.png)

全局变量可以通过 `${key}` 的语法引用，并且全局变量的默认值中也可以引用其他的全局变量，只要保证无循环引用即可。多个任务节点的输入参数引用同一个全局变量，可以实现参数共享，减少创建任务时需要填写的参数；任务节点输入参数通过形如 `xxx${key}` 方式部分引用全局变量，可以实现简化输入参数的目的；任务节点输入参数或者分支条件表达式通过引用之前的任务节点的输出参数生成的全局变量，可以实现根据任务节点输出控制后面节点输入参数和分支流程走向。

![g5](../assets/sops007.png)
